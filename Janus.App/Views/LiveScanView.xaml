<UserControl x:Class="Janus.App.LiveScanView"
    xmlns:local="clr-namespace:Janus.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="800">
    <UserControl.Resources>
        <local:StringNotEmptyToVisibleConverter x:Key="StringNotEmptyToVisible" />
        <local:FirstLineConverter x:Key="FirstLineConverter" />
        <local:LogLevelSelectedConverter x:Key="LogLevelSelectedConverter" />
    </UserControl.Resources>
    <Grid Margin="20">
        <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/> <!-- For Back button -->
        </Grid.RowDefinitions>
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,10">
            <TextBlock Text="Timestamp of Interest:" VerticalAlignment="Center" Margin="0,0,10,0"/>
            <DatePicker x:Name="TimestampPicker" SelectedDate="{Binding Timestamp}" Width="140" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}"/>
            <TextBox x:Name="TimeOfDayBox" Text="{Binding TimeOfDay}" Width="100" Margin="10,0,0,0"/>
            <Button Content="Now" Command="{Binding SetNowCommand}" Margin="10,0,0,0"/>
        </StackPanel>
        <StackPanel Orientation="Horizontal" Grid.Row="1" Margin="0,0,0,10">
            <TextBlock Text="Minutes Before:" VerticalAlignment="Center" Margin="0,0,10,0"/>
            <TextBox x:Name="MinutesBeforeBox" Text="{Binding MinutesBefore, Mode=TwoWay}" Width="60"/>
            <TextBlock Text="Minutes After:" VerticalAlignment="Center" Margin="20,0,10,0"/>
            <TextBox x:Name="MinutesAfterBox" Text="{Binding MinutesAfter, Mode=TwoWay}" Width="60"/>
        </StackPanel>
        <StackPanel Orientation="Horizontal" Grid.Row="2" Margin="0,0,0,10">
            <Button Content="Scan Events" Command="{Binding ScanCommand}" Width="120" IsDefault="True"/>
            <Button Content="Cancel" Command="{Binding CancelCommand}" Width="80" Margin="10,0,0,0" IsCancel="True"/>
        </StackPanel>
        <TextBlock Grid.Row="4" Text="{Binding ScanStatus}" FontWeight="Bold" Foreground="DarkBlue" Margin="0,0,0,10"/>
        <!-- Back button in lower left -->
        <Button Grid.Row="6" Content="Back" Command="{Binding BackCommand}" Width="80" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="0,10,0,0" IsEnabled="{Binding IsScanInProgress, Converter={StaticResource InverseBooleanConverter}}"/>
        <!-- Scan progress list -->
        <ListBox ItemsSource="{Binding ScannedSources}" Grid.Row="5"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 ScrollViewer.CanContentScroll="True"
                 BorderThickness="0"
                 SelectionMode="Single"
                 HorizontalContentAlignment="Stretch"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ToolTip="Sources scanned">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <Grid Margin="0,0,0,1">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Center">
                  <ContentControl Margin="0,0,6,0" VerticalAlignment="Center">
                    <ContentControl.Style>
                      <Style TargetType="ContentControl">
                        <Setter Property="ContentTemplate">
                          <Setter.Value>
                            <DataTemplate>
                              <Ellipse Width="12" Height="12" Fill="Gray"/>
                            </DataTemplate>
                          </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                          <!-- In-progress icon: show when actively scanning -->
                          <DataTrigger Binding="{Binding IsActive}" Value="True">
                            <Setter Property="ContentTemplate">
                              <Setter.Value>
                                <DataTemplate>
                                  <Ellipse Width="12" Height="12" Fill="DodgerBlue"/>
                                </DataTemplate>
                              </Setter.Value>
                            </Setter>
                          </DataTrigger>
                          <!-- Success icon: only when not active and status is Success -->
                          <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                              <Condition Binding="{Binding IsActive}" Value="False"/>
                              <Condition Binding="{Binding Status}" Value="Success"/>
                            </MultiDataTrigger.Conditions>
                            <Setter Property="ContentTemplate">
                              <Setter.Value>
                                <DataTemplate>
                                  <Path Data="M2,7 L6,11 L14,3" Stroke="Green" StrokeThickness="2" Fill="Transparent" Width="12" Height="12"/>
                                </DataTemplate>
                              </Setter.Value>
                            </Setter>
                          </MultiDataTrigger>
                          <DataTrigger Binding="{Binding Status}" Value="Partial">
                            <Setter Property="ContentTemplate">
                              <Setter.Value>
                                <DataTemplate>
                                  <Path Data="M2,7 L12,7" Stroke="Orange" StrokeThickness="2" Fill="Transparent" Width="12" Height="12"/>
                                </DataTemplate>
                              </Setter.Value>
                            </Setter>
                          </DataTrigger>
                          <DataTrigger Binding="{Binding Status}" Value="Failed">
                            <Setter Property="ContentTemplate">
                              <Setter.Value>
                                <DataTemplate>
                                  <Path Data="M3,3 L11,11 M11,3 L3,11" Stroke="Red" StrokeThickness="2" Fill="Transparent" Width="12" Height="12"/>
                                </DataTemplate>
                              </Setter.Value>
                            </Setter>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </ContentControl.Style>
                  </ContentControl>
                  <Border Background="#FFE0E0E0" CornerRadius="3" Margin="0,0,6,0" Padding="2,0,2,0"
                          VerticalAlignment="Center" MinWidth="32">
                    <TextBlock Text="{Binding EventsRetrieved}" FontSize="9"
                               VerticalAlignment="Center" Foreground="Black"/>
                  </Border>
                </StackPanel>
                <TextBlock Grid.Column="1" Text="{Binding SourceName}" FontSize="10" TextWrapping="Wrap" VerticalAlignment="Center" />
                <!-- Progress bar or spinner -->
                <Grid Grid.Column="2" VerticalAlignment="Center" Margin="8,0,0,0">
                  <Grid>
                    <Grid.Style>
                      <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding IsTotalKnown}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Grid.Style>
                    <ProgressBar Minimum="0" Maximum="{Binding TotalEvents}" Value="{Binding EventsRetrieved}" Width="60" Height="8"/>
                  </Grid>
                  <Grid>
                    <Grid.Style>
                      <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding IsTotalKnown}" Value="False">
                            <Setter Property="Visibility" Value="Visible"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Grid.Style>
                    <StackPanel Orientation="Horizontal">
                      <TextBlock Text="Scanning..." FontSize="9" Foreground="Gray" VerticalAlignment="Center">
                        <TextBlock.Style>
                          <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding IsActive}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </TextBlock.Style>
                      </TextBlock>
                      <TextBlock Text="{Binding ExceptionMessage}" FontSize="9" Foreground="Red" VerticalAlignment="Center" TextWrapping="Wrap">
                        <TextBlock.Style>
                          <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding Status}" Value="Failed">
                                <Setter Property="Visibility" Value="Visible"/>
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </TextBlock.Style>
                      </TextBlock>
                    </StackPanel>
                  </Grid>
                </Grid>
              </Grid>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
    </Grid>
</UserControl>
